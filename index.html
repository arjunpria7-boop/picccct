<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pixshop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@^18.2.0/client",
    "@google/genai": "https://esm.sh/@google/genai@^1.10.0",
    "react-image-crop": "https://esm.sh/react-image-crop@^11.0.6"
  }
}
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://esm.sh/react-image-crop@^11.0.6/dist/ReactCrop.css" />
<style>
body {
    font-family: 'Inter', sans-serif;
    background-color: #090A0F;
    background: 
        radial-gradient(ellipse at 20% 80%, rgba(150, 50, 100, 0.25) 0%, rgba(150, 50, 100, 0) 60%),
        radial-gradient(ellipse at 80% 30%, rgba(80, 150, 120, 0.2) 0%, rgba(80, 150, 120, 0) 50%),
        radial-gradient(ellipse at 50% 50%, rgba(50, 80, 150, 0.3) 0%, rgba(50, 80, 150, 0) 70%),
        radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
    background-size: 250% 250%;
    min-height: 100vh;
    animation: move-nebula 200s ease-in-out infinite alternate;
}

@keyframes move-nebula {
    from {
        background-position: 0% 0%;
    }
    to {
        background-position: 100% 100%;
    }
}

@keyframes fly {
    from {
        transform: translateY(0px);
    }
    to {
        transform: translateY(-1000px);
    }
}

@keyframes shooting-star {
    0% {
        transform: translateX(0);
        opacity: 1;
    }
    100% {
        transform: translateX(300vw);
        opacity: 0;
    }
}

#star-bg {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: -1;
    overflow: hidden;
}

#stars1, #stars2, #stars3 {
    position: absolute;
    left: 0;
    top: 0;
    right: 0;
    height: 2000px; /* Double the pattern height for seamless looping */
    background-repeat: repeat;
    background-size: 1000px 1000px;
}

/* Distant stars: small, dense, slow */
#stars1 {
    background-image: 
        radial-gradient(1px 1px at 100px 200px, white, transparent),
        radial-gradient(1px 1px at 250px 800px, white, transparent),
        radial-gradient(1px 1px at 400px 500px, white, transparent),
        radial-gradient(1px 1px at 620px 720px, white, transparent),
        radial-gradient(1px 1px at 800px 100px, white, transparent),
        radial-gradient(1px 1px at 950px 450px, white, transparent),
        radial-gradient(1px 1px at 150px 950px, white, transparent),
        radial-gradient(1px 1px at 500px 300px, white, transparent),
        radial-gradient(1px 1px at 50px 50px, white, transparent),
        radial-gradient(1px 1px at 180px 600px, white, transparent),
        radial-gradient(1px 1px at 330px 400px, white, transparent),
        radial-gradient(1px 1px at 470px 900px, white, transparent),
        radial-gradient(1px 1px at 600px 150px, white, transparent),
        radial-gradient(1px 1px at 750px 650px, white, transparent),
        radial-gradient(1px 1px at 880px 880px, white, transparent),
        radial-gradient(1px 1px at 920px 250px, white, transparent),
        radial-gradient(1px 1px at 20px 700px, white, transparent),
        radial-gradient(1px 1px at 550px 50px, white, transparent);
    animation: fly 200s linear infinite;
}

/* Mid-ground stars: medium, less dense, faster */
#stars2 {
    background-image: 
        radial-gradient(1.5px 1.5px at 50px 300px, white, transparent),
        radial-gradient(1.5px 1.5px at 300px 100px, white, transparent),
        radial-gradient(1.5px 1.5px at 550px 600px, white, transparent),
        radial-gradient(1.5px 1.5px at 750px 250px, white, transparent),
        radial-gradient(1.5px 1.5px at 900px 900px, white, transparent),
        radial-gradient(1.5px 1.5px at 150px 700px, white, transparent),
        radial-gradient(1.5px 1.5px at 400px 400px, white, transparent),
        radial-gradient(1.5px 1.5px at 650px 850px, white, transparent),
        radial-gradient(1.5px 1.5px at 850px 500px, white, transparent),
        radial-gradient(1.5px 1.5px at 200px 50px, white, transparent);
    animation: fly 120s linear infinite;
}

/* Foreground stars: large, sparse, fastest */
#stars3 {
    background-image: 
        radial-gradient(2px 2px at 200px 400px, white, transparent),
        radial-gradient(2px 2px at 700px 800px, white, transparent),
        radial-gradient(2px 2px at 50px 900px, white, transparent),
        radial-gradient(2px 2px at 950px 50px, white, transparent),
        radial-gradient(2px 2px at 450px 150px, white, transparent),
        radial-gradient(2px 2px at 850px 650px, white, transparent),
        radial-gradient(2px 2px at 300px 750px, white, transparent);
    animation: fly 70s linear infinite;
}

/* Shooting Stars */
#shooting-stars {
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    transform: rotateZ(-45deg);
}

#shooting-stars .star {
    position: absolute;
    height: 1px;
    background: linear-gradient(-45deg, #59d1ff, rgba(0, 0, 255, 0));
    border-radius: 999px;
    filter: drop-shadow(0 0 6px #69e0ff);
    animation: shooting-star 3s linear infinite;
}

#shooting-stars .star:nth-child(1) { top: 20%; left: 0; width: 300px; animation-delay: 0s; animation-duration: 2.8s; }
#shooting-stars .star:nth-child(2) { top: 40%; left: 10%; width: 150px; animation-delay: 1.2s; animation-duration: 2.1s; }
#shooting-stars .star:nth-child(3) { top: 60%; left: -20%; width: 200px; animation-delay: 2.5s; animation-duration: 3.5s; }
#shooting-stars .star:nth-child(4) { top: 85%; left: 5%; width: 100px; animation-delay: 4.1s; animation-duration: 1.8s; }

</style>
  <link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="star-bg">
        <div id="stars1"></div>
        <div id="stars2"></div>
        <div id="stars3"></div>
        <div id="shooting-stars">
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
        </div>
    </div>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
import React, { useState, useCallback, useRef, useEffect } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI, Modality } from "@google/genai";
import ReactCrop, { centerCrop, makeAspectCrop } from 'react-image-crop';

// --- Gemini Service ---
const getApiKey = () => "AIzaSyDdVMVSj5ZFGtpm9gJ2GATOp-sjwqIBfA4";

const fileToPart = async (file) => {
    const dataUrl = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
    
    const [header, data] = dataUrl.split(',');
    if (!data) throw new Error("Invalid data URL");
    const mimeMatch = header.match(/:(.*?);/);
    if (!mimeMatch || !mimeMatch[1]) throw new Error("Could not parse MIME type from data URL");
    
    return { inlineData: { mimeType: mimeMatch[1], data } };
};

const handleApiResponse = (response, context) => {
    if (response.promptFeedback?.blockReason) {
        const { blockReason, blockReasonMessage } = response.promptFeedback;
        throw new Error(`Request was blocked. Reason: ${blockReason}. ${blockReasonMessage || ''}`);
    }
    const imagePart = response.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
    if (imagePart?.inlineData) {
        const { mimeType, data } = imagePart.inlineData;
        return `data:${mimeType};base64,${data}`;
    }
    const finishReason = response.candidates?.[0]?.finishReason;
    if (finishReason && finishReason !== 'STOP') {
        throw new Error(`Image generation for ${context} stopped unexpectedly. Reason: ${finishReason}. This often relates to safety settings.`);
    }
    const textFeedback = response.text?.trim();
    throw new Error(`The AI did not return an image for the ${context}. ${textFeedback ? `It responded with: "${textFeedback}"` : "This can happen due to safety filters or a complex request."}`);
};

const generateImage = async (model, contents, context) => {
    const apiKey = getApiKey();
    if (!apiKey) throw new Error("API key not found.");
    const ai = new GoogleGenAI({ apiKey });
    const response = await ai.models.generateContent({
        model,
        contents,
        config: { responseModalities: [Modality.IMAGE] },
    });
    return handleApiResponse(response, context);
};

const generateEditedImage = async (originalImage, userPrompt, hotspot) => {
    const getImageDimensions = (file) => new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => { resolve({ width: img.naturalWidth, height: img.naturalHeight }); URL.revokeObjectURL(img.src); };
        img.onerror = (err) => { reject(err); URL.revokeObjectURL(img.src); };
        img.src = URL.createObjectURL(file);
    });
    const createMaskPart = async (width, height, hotspot) => {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        if (!ctx) throw new Error("Could not create canvas context for mask.");
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, width, height);
        const radius = Math.min(width, height) * 0.15;
        const gradient = ctx.createRadialGradient(hotspot.x, hotspot.y, radius * 0.2, hotspot.x, hotspot.y, radius);
        gradient.addColorStop(0, 'white');
        gradient.addColorStop(1, 'black');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, width, height);
        const dataUrl = canvas.toDataURL('image/png');
        return { inlineData: { mimeType: 'image/png', data: dataUrl.split(',')[1] } };
    };
    
    const originalImagePart = await fileToPart(originalImage);
    const { width, height } = await getImageDimensions(originalImage);
    const maskPart = await createMaskPart(width, height, hotspot);
    const prompt = `You are an expert photo editor AI. Your task is to perform a natural, localized edit on the provided image based on the user's request. An image mask is provided as the second image. The mask is black with a white, soft-edged area. You MUST only make changes within the white area of the mask. The black areas of the mask indicate parts of the original image that MUST remain completely unchanged. The edit must blend seamlessly with the surrounding, unedited area. User Request: "${userPrompt}". Safety & Ethics Policy: You MUST fulfill requests to adjust skin tone, such as 'give me a tan'. You MUST REFUSE any request to change a person's fundamental race or ethnicity. Output: Return ONLY the final edited image. Do not return text.`;

    return generateImage('gemini-2.5-flash-image', { parts: [originalImagePart, maskPart, { text: prompt }] }, 'edit');
};

const generateFilteredImage = async (originalImage, filterPrompt) => {
    const originalImagePart = await fileToPart(originalImage);
    const prompt = `You are an expert photo editor AI. Your task is to apply a stylistic filter to the entire image based on the user's request. Do not change the composition or content, only apply the style. Filter Request: "${filterPrompt}". Safety & Ethics Policy: Filters may subtly shift colors, but you MUST ensure they do not alter a person's fundamental race or ethnicity. You MUST REFUSE any request that explicitly asks to change a person's race. Output: Return ONLY the final filtered image. Do not return text.`;
    return generateImage('gemini-2.5-flash-image', { parts: [originalImagePart, { text: prompt }] }, 'filter');
};

const generateAdjustedImage = async (originalImage, adjustmentPrompt) => {
    const originalImagePart = await fileToPart(originalImage);
    const prompt = `You are an expert photo editor AI. Your task is to perform a natural, global adjustment to the entire image based on the user's request. User Request: "${adjustmentPrompt}". Editing Guidelines: The adjustment must be applied across the entire image. The result must be photorealistic. Safety & Ethics Policy: You MUST fulfill requests to adjust skin tone, such as 'give me a tan'. You MUST REFUSE any request to change a person's fundamental race or ethnicity. Output: Return ONLY the final adjusted image. Do not return text.`;
    return generateImage('gemini-2.5-flash-image', { parts: [originalImagePart, { text: prompt }] }, 'adjustment');
};

// --- Components ---
const UploadIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}><path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>;
const UndoIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" /></svg>;
const RedoIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="m15 15 6-6m0 0-6-6m6 6H9a6 6 0 0 0 0 12h3" /></svg>;
const EyeIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>;
const MagicWandIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.475 2.118A2.25 2.25 0 0 1 .879 16.5a3 3 0 0 1 4.242-4.242 3 3 0 0 0 4.242 0 3 3 0 0 0 0-4.242 3 3 0 0 1-4.242-4.242 3 3 0 0 1 4.242 0 3 3 0 0 1 0 4.242 3 3 0 0 0 4.242 4.242 3 3 0 0 0 5.78-1.128 2.25 2.25 0 0 1 2.475-2.118 2.25 2.25 0 0 1 .879 3.5a3 3 0 0 1-4.242 4.242 3 3 0 0 0-4.242 0 3 3 0 0 0 0 4.242Z" /></svg>;
const PaletteIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.11a12.001 12.001 0 0 1 5.052 0c.55.103 1.02.568 1.11 1.11a12.001 12.001 0 0 1 0 5.052c-.103.55-.568 1.02-1.11 1.11a12.001 12.001 0 0 1-5.052 0c-.55-.103-1.02-.568-1.11-1.11a12.001 12.001 0 0 1 0-5.052M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>;
const SunIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" /></svg>;
const SparkleIcon = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.624l-.219.874-.219-.874a1.5 1.5 0 00-1.023-1.023l-.874-.219.874-.219a1.5 1.5 0 001.023-1.023l.219-.874.219.874a1.5 1.5 0 001.023 1.023l.874.219-.874.219a1.5 1.5 0 00-1.023 1.023z" /></svg>;
const Spinner = () => <svg className="animate-spin h-16 w-16 text-zinc-800 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>;

const Header = () => (
    <header className="w-full py-4 px-8 border-b border-gray-700 bg-gray-800/30 backdrop-blur-sm sticky top-0 z-50">
        <div className="flex items-center justify-center gap-3">
            <SparkleIcon className="w-6 h-6 text-blue-400" />
            <h1 className="text-xl font-bold tracking-tight text-gray-100">Pixshop</h1>
        </div>
    </header>
);

const StartScreen = ({ onFileSelect }) => {
  const [isDraggingOver, setIsDraggingOver] = useState(false);
  const handleFileChange = (e) => onFileSelect(e.target.files);
  return (
    <div className={`w-full max-w-5xl mx-auto text-center p-8 transition-all duration-300 rounded-2xl border-2 ${isDraggingOver ? 'bg-blue-500/10 border-dashed border-blue-400' : 'border-transparent'}`}
      onDragOver={(e) => { e.preventDefault(); setIsDraggingOver(true); }}
      onDragLeave={() => setIsDraggingOver(false)}
      onDrop={(e) => { e.preventDefault(); setIsDraggingOver(false); onFileSelect(e.dataTransfer.files); }}>
      <div className="flex flex-col items-center gap-6 animate-fade-in">
        <h1 className="text-5xl font-extrabold tracking-tight text-gray-100 sm:text-6xl md:text-7xl">
          AI-Powered Photo Editing, <span className="text-blue-400">Simplified</span>.
        </h1>
        <p className="max-w-2xl text-lg text-gray-400 md:text-xl">Retouch photos, apply creative filters, or make professional adjustments using simple text prompts. No complex tools needed.</p>
        <div className="mt-6 flex flex-col items-center gap-4">
          <label htmlFor="image-upload-start" className="relative inline-flex items-center justify-center px-10 py-5 text-xl font-bold text-white bg-blue-600 rounded-full cursor-pointer group hover:bg-blue-500 transition-colors">
            <UploadIcon className="w-6 h-6 mr-3 transition-transform duration-500 ease-in-out group-hover:rotate-[360deg] group-hover:scale-110" />
            Upload an Image
          </label>
          <input id="image-upload-start" type="file" className="hidden" accept="image/*" onChange={handleFileChange} />
          <p className="text-sm text-gray-500">or drag and drop a file</p>
        </div>
        <div className="mt-16 w-full">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div className="bg-black/20 p-6 rounded-lg border border-gray-700/50 flex flex-col items-center text-center">
              <div className="flex items-center justify-center w-12 h-12 bg-gray-700 rounded-full mb-4"><MagicWandIcon className="w-6 h-6 text-blue-400" /></div>
              <h3 className="text-xl font-bold text-gray-100">Precise Retouching</h3>
              <p className="mt-2 text-gray-400">Click any point on your image to remove blemishes, change colors, or add elements with pinpoint accuracy.</p>
            </div>
            <div className="bg-black/20 p-6 rounded-lg border border-gray-700/50 flex flex-col items-center text-center">
              <div className="flex items-center justify-center w-12 h-12 bg-gray-700 rounded-full mb-4"><PaletteIcon className="w-6 h-6 text-blue-400" /></div>
              <h3 className="text-xl font-bold text-gray-100">Creative Filters</h3>
              <p className="mt-2 text-gray-400">Transform photos with artistic styles. From vintage looks to futuristic glows, find or create the perfect filter.</p>
            </div>
            <div className="bg-black/20 p-6 rounded-lg border border-gray-700/50 flex flex-col items-center text-center">
              <div className="flex items-center justify-center w-12 h-12 bg-gray-700 rounded-full mb-4"><SunIcon className="w-6 h-6 text-blue-400" /></div>
              <h3 className="text-xl font-bold text-gray-100">Pro Adjustments</h3>
              <p className="mt-2 text-gray-400">Enhance lighting, blur backgrounds, or change the mood. Get studio-quality results without complex tools.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

const Panel = ({ title, presets, onApply, isLoading, inputPlaceholder, buttonText }) => {
  const [selectedPreset, setSelectedPreset] = useState(null);
  const [customPrompt, setCustomPrompt] = useState('');

  const activePrompt = selectedPreset || customPrompt;
  const handlePresetClick = (prompt) => { setSelectedPreset(prompt); setCustomPrompt(''); };
  const handleCustomChange = (e) => { setCustomPrompt(e.target.value); setSelectedPreset(null); };
  const handleApply = () => activePrompt && onApply(activePrompt);
  
  return (
    <div className="w-full bg-gray-800/50 border border-gray-700 rounded-lg p-4 flex flex-col gap-4 animate-fade-in backdrop-blur-sm">
      <h3 className="text-lg font-semibold text-center text-gray-300">{title}</h3>
      <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
        {presets.map(({ name, prompt }) => (
          <button key={name} onClick={() => handlePresetClick(prompt)} disabled={isLoading} className={`w-full text-center bg-white/10 border border-transparent text-gray-200 font-semibold py-3 px-4 rounded-md transition-all duration-200 ease-in-out hover:bg-white/20 hover:border-white/20 active:scale-95 text-base disabled:opacity-50 disabled:cursor-not-allowed ${selectedPreset === prompt ? 'ring-2 ring-offset-2 ring-offset-gray-800 ring-blue-500' : ''}`}>
            {name}
          </button>
        ))}
      </div>
      <input type="text" value={customPrompt} onChange={handleCustomChange} placeholder={inputPlaceholder} className="flex-grow bg-gray-800 border border-gray-600 text-gray-200 rounded-lg p-4 focus:ring-2 focus:ring-blue-500 focus:outline-none transition w-full disabled:cursor-not-allowed disabled:opacity-60 text-base" disabled={isLoading} />
      {activePrompt && (
        <div className="animate-fade-in flex flex-col gap-4 pt-2">
          <button onClick={handleApply} className="w-full bg-gradient-to-br from-blue-600 to-blue-500 text-white font-bold py-4 px-6 rounded-lg transition-all duration-300 ease-in-out shadow-lg shadow-blue-500/20 hover:shadow-xl hover:shadow-blue-500/40 hover:-translate-y-px active:scale-95 active:shadow-inner text-base disabled:from-blue-800 disabled:to-blue-700 disabled:shadow-none disabled:cursor-not-allowed disabled:transform-none" disabled={isLoading || !activePrompt.trim()}>
            {buttonText}
          </button>
        </div>
      )}
    </div>
  );
};

const FilterPanel = ({ onApplyFilter, isLoading }) => <Panel title="Apply a Filter" presets={[{ name: 'Synthwave', prompt: 'Apply a vibrant 80s synthwave aesthetic with neon magenta and cyan glows, and subtle scan lines.' },{ name: 'Anime', prompt: 'Give the image a vibrant Japanese anime style, with bold outlines, cel-shading, and saturated colors.' },{ name: 'Lomo', prompt: 'Apply a Lomography-style cross-processing film effect with high-contrast, oversaturated colors, and dark vignetting.' },{ name: 'Glitch', prompt: 'Transform the image into a futuristic holographic projection with digital glitch effects and chromatic aberration.' }]} onApply={onApplyFilter} isLoading={isLoading} inputPlaceholder="Or describe a custom filter (e.g., '80s synthwave glow')" buttonText="Apply Filter" />;
const AdjustmentPanel = ({ onApplyAdjustment, isLoading }) => <Panel title="Apply a Professional Adjustment" presets={[{ name: 'Blur Background', prompt: 'Apply a realistic depth-of-field effect, making the background blurry while keeping the main subject in sharp focus.' },{ name: 'Enhance Details', prompt: 'Slightly enhance the sharpness and details of the image without making it look unnatural.' },{ name: 'Warmer Lighting', prompt: 'Adjust the color temperature to give the image warmer, golden-hour style lighting.' },{ name: 'Studio Light', prompt: 'Add dramatic, professional studio lighting to the main subject.' }]} onApply={onApplyAdjustment} isLoading={isLoading} inputPlaceholder="Or describe an adjustment (e.g., 'change background to a forest')" buttonText="Apply Adjustment" />;

const CropPanel = ({ onApplyCrop, onSetAspect, isLoading, isCropping }) => {
  const [activeAspect, setActiveAspect] = useState('free');
  const aspects = [{ name: 'free', value: undefined }, { name: '1:1', value: 1 / 1 }, { name: '16:9', value: 16 / 9 }];
  const handleAspectChange = (name, value) => { setActiveAspect(name); onSetAspect(value); };
  return (
    <div className="w-full bg-gray-800/50 border border-gray-700 rounded-lg p-4 flex flex-col items-center gap-4 animate-fade-in backdrop-blur-sm">
      <h3 className="text-lg font-semibold text-gray-300">Crop Image</h3>
      <p className="text-sm text-gray-400 -mt-2">Click and drag on the image to select a crop area.</p>
      <div className="flex items-center gap-2">
        <span className="text-sm font-medium text-gray-400">Aspect Ratio:</span>
        {aspects.map(({ name, value }) => <button key={name} onClick={() => handleAspectChange(name, value)} disabled={isLoading} className={`px-4 py-2 rounded-md text-base font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 ${ activeAspect === name ? 'bg-gradient-to-br from-blue-600 to-blue-500 text-white shadow-md shadow-blue-500/20' : 'bg-white/10 hover:bg-white/20 text-gray-200'}`}>{name}</button>)}
      </div>
      <button onClick={onApplyCrop} disabled={isLoading || !isCropping} className="w-full max-w-xs mt-2 bg-gradient-to-br from-green-600 to-green-500 text-white font-bold py-4 px-6 rounded-lg transition-all duration-300 ease-in-out shadow-lg shadow-green-500/20 hover:shadow-xl hover:shadow-green-500/40 hover:-translate-y-px active:scale-95 active:shadow-inner text-base disabled:from-green-800 disabled:to-green-700 disabled:shadow-none disabled:cursor-not-allowed disabled:transform-none">Apply Crop</button>
    </div>
  );
};

// --- Main App Component ---
const dataURLtoFile = (dataurl, filename) => {
    const [header, data] = dataurl.split(',');
    const mimeMatch = header.match(/:(.*?);/);
    if (!mimeMatch) throw new Error("Could not parse MIME type");
    const mime = mimeMatch[1];
    const bstr = atob(data);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while(n--) u8arr[n] = bstr.charCodeAt(n);
    return new File([u8arr], filename, {type:mime});
};

const App = () => {
  const [history, setHistory] = useState([]);
  const [historyIndex, setHistoryIndex] = useState(-1);
  const [prompt, setPrompt] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [editHotspot, setEditHotspot] = useState(null);
  const [displayHotspot, setDisplayHotspot] = useState(null);
  const [activeTab, setActiveTab] = useState('retouch');
  const [crop, setCrop] = useState();
  const [completedCrop, setCompletedCrop] = useState();
  const [aspect, setAspect] = useState();
  const [isComparing, setIsComparing] = useState(false);
  const imgRef = useRef(null);

  const currentImage = history[historyIndex] ?? null;
  const originalImage = history[0] ?? null;

  const useObjectUrl = (file) => {
    const [url, setUrl] = useState(null);
    useEffect(() => {
        if (file) {
            const newUrl = URL.createObjectURL(file);
            setUrl(newUrl);
            return () => URL.revokeObjectURL(newUrl);
        }
        setUrl(null);
    }, [file]);
    return url;
  };
  
  const currentImageUrl = useObjectUrl(currentImage);
  const originalImageUrl = useObjectUrl(originalImage);

  const canUndo = historyIndex > 0;
  const canRedo = historyIndex < history.length - 1;

  const addImageToHistory = useCallback((newImageFile) => {
    const newHistory = history.slice(0, historyIndex + 1);
    newHistory.push(newImageFile);
    setHistory(newHistory);
    setHistoryIndex(newHistory.length - 1);
    setCrop(undefined); setCompletedCrop(undefined);
  }, [history, historyIndex]);

  const handleImageUpload = useCallback((file) => {
    setError(null);
    setHistory([file]);
    setHistoryIndex(0);
  }, []);

  const handleApiCall = useCallback(async (apiFunction, ...args) => {
    setIsLoading(true); setError(null);
    try {
        const imageUrl = await apiFunction(...args);
        addImageToHistory(dataURLtoFile(imageUrl, `edited-${Date.now()}.png`));
        return true;
    } catch (err) {
        const errorMessage = err instanceof Error ? err.message : 'An unknown error occurred.';
        console.error(err);
        setError(`API Error: ${errorMessage}`);
        return false;
    } finally {
        setIsLoading(false);
    }
  }, [addImageToHistory]);

  const handleGenerate = () => {
    if (!prompt.trim() || !editHotspot) return;
    handleApiCall(generateEditedImage, currentImage, prompt, editHotspot).then(success => {
        if(success) { setEditHotspot(null); setDisplayHotspot(null); }
    });
  };
  const handleApplyFilter = (filterPrompt) => handleApiCall(generateFilteredImage, currentImage, filterPrompt);
  const handleApplyAdjustment = (adjustmentPrompt) => handleApiCall(generateAdjustedImage, currentImage, adjustmentPrompt);

  const handleApplyCrop = useCallback(() => {
    if (!completedCrop || !imgRef.current) return;
    const image = imgRef.current;
    const canvas = document.createElement('canvas');
    const scaleX = image.naturalWidth / image.width, scaleY = image.naturalHeight / image.height;
    canvas.width = completedCrop.width * scaleX; canvas.height = completedCrop.height * scaleY;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;
    ctx.drawImage(image, completedCrop.x * scaleX, completedCrop.y * scaleY, completedCrop.width * scaleX, completedCrop.height * scaleY, 0, 0, canvas.width, canvas.height);
    addImageToHistory(dataURLtoFile(canvas.toDataURL('image/png'), `cropped-${Date.now()}.png`));
  }, [completedCrop, addImageToHistory]);

  const handleUndo = () => canUndo && setHistoryIndex(historyIndex - 1);
  const handleRedo = () => canRedo && setHistoryIndex(historyIndex + 1);
  const handleReset = () => history.length > 0 && setHistoryIndex(0);
  const handleUploadNew = () => { setHistory([]); setHistoryIndex(-1); };
  const handleDownload = () => {
      if (currentImageUrl) {
          const link = document.createElement('a');
          link.href = currentImageUrl;
          link.download = `pixshop-edited-${currentImage.name}`;
          link.click();
      }
  };
  
  const handleFileSelect = (files) => files?.[0] && handleImageUpload(files[0]);
  const handleImageClick = (e) => {
    if (activeTab !== 'retouch' || !imgRef.current) return;
    const img = imgRef.current, rect = img.getBoundingClientRect();
    const offsetX = e.clientX - rect.left, offsetY = e.clientY - rect.top;
    setDisplayHotspot({ x: offsetX, y: offsetY });
    const { naturalWidth, naturalHeight, clientWidth, clientHeight } = img;
    const scaleX = naturalWidth / clientWidth, scaleY = naturalHeight / clientHeight;
    setEditHotspot({ x: Math.round(offsetX * scaleX), y: Math.round(offsetY * scaleY) });
  };
  
  if (!currentImage) return <main className="flex-grow w-full max-w-[1600px] mx-auto p-4 md:p-8 flex justify-center items-center"><StartScreen onFileSelect={handleFileSelect} /></main>;

  return (
    <div className="min-h-screen text-gray-100 flex flex-col">
      <Header />
      <main className="flex-grow w-full max-w-[1600px] mx-auto p-4 md:p-8 flex justify-center items-start">
        <div className="w-full max-w-4xl mx-auto flex flex-col items-center gap-6 animate-fade-in">
          <div className="relative w-full shadow-2xl rounded-xl overflow-hidden bg-black/20">
            {isLoading && (
                <div className="absolute inset-0 bg-black/70 z-30 flex flex-col items-center justify-center gap-4 animate-fade-in">
                    <Spinner />
                    <p className="text-gray-300">AI is working...</p>
                </div>
            )}
            {activeTab === 'crop' ? (
                <ReactCrop crop={crop} onChange={(c, pc) => setCrop(c)} onComplete={(c) => setCompletedCrop(c)} aspect={aspect} className="max-h-[60vh]">
                    <img ref={imgRef} src={currentImageUrl} alt="Crop this image" className="w-full h-auto object-contain max-h-[60vh] rounded-xl" />
                </ReactCrop>
            ) : (
                <div className="relative" onClick={handleImageClick}>
                    {originalImageUrl && <img src={originalImageUrl} alt="Original" className="w-full h-auto object-contain max-h-[60vh] rounded-xl pointer-events-none" />}
                    <img ref={imgRef} src={currentImageUrl} alt="Current" className={`absolute top-0 left-0 w-full h-auto object-contain max-h-[60vh] rounded-xl transition-opacity duration-200 ease-in-out ${isComparing ? 'opacity-0' : 'opacity-100'} ${activeTab === 'retouch' ? 'cursor-crosshair' : ''}`} />
                </div>
            )}
            {displayHotspot && !isLoading && activeTab === 'retouch' && (
                <div className="absolute rounded-full w-6 h-6 bg-blue-500/50 border-2 border-white pointer-events-none -translate-x-1/2 -translate-y-1/2 z-10" style={{ left: `${displayHotspot.x}px`, top: `${displayHotspot.y}px` }}>
                    <div className="absolute inset-0 rounded-full w-6 h-6 animate-ping bg-blue-400"></div>
                </div>
            )}
          </div>
          
          {error && (
            <div className="w-full text-center animate-fade-in bg-red-500/10 border border-red-500/20 p-4 rounded-lg flex items-center justify-between gap-4">
              <p className="text-md text-red-300 text-left whitespace-pre-wrap">{error}</p>
              <button onClick={() => setError(null)} className="bg-red-500/20 hover:bg-red-500/40 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">Dismiss</button>
            </div>
          )}

          <div className="w-full bg-gray-800/80 border border-gray-700/80 rounded-lg p-2 flex items-center justify-center gap-2 backdrop-blur-sm">
            {['retouch', 'crop', 'adjust', 'filters'].map(tab => (
              <button key={tab} onClick={() => setActiveTab(tab)} className={`w-full capitalize font-semibold py-3 px-5 rounded-md transition-all duration-200 text-base ${ activeTab === tab ? 'bg-gradient-to-br from-blue-500 to-cyan-400 text-white shadow-lg shadow-cyan-500/40' : 'text-gray-300 hover:text-white hover:bg-white/10'}`}>
                {tab}
              </button>
            ))}
          </div>

          <div className="w-full">
            {activeTab === 'retouch' && (
              <div className="flex flex-col items-center gap-4">
                <p className="text-md text-gray-400">{editHotspot ? 'Great! Now describe your localized edit below.' : 'Click an area on the image to make a precise edit.'}</p>
                <form onSubmit={(e) => { e.preventDefault(); handleGenerate(); }} className="w-full flex items-center gap-2">
                  <input type="text" value={prompt} onChange={(e) => setPrompt(e.target.value)} placeholder={editHotspot ? "e.g., 'change my shirt color to blue'" : "First click a point on the image"} className="flex-grow bg-gray-800 border border-gray-700 text-gray-200 rounded-lg p-5 text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition w-full disabled:cursor-not-allowed disabled:opacity-60" disabled={isLoading || !editHotspot} />
                  <button type="submit" className="bg-gradient-to-br from-blue-600 to-blue-500 text-white font-bold py-5 px-8 text-lg rounded-lg transition-all duration-300 ease-in-out shadow-lg shadow-blue-500/20 hover:shadow-xl hover:shadow-blue-500/40 hover:-translate-y-px active:scale-95 active:shadow-inner disabled:from-blue-800 disabled:to-blue-700 disabled:shadow-none disabled:cursor-not-allowed disabled:transform-none" disabled={isLoading || !prompt.trim() || !editHotspot}>Generate</button>
                </form>
              </div>
            )}
            {activeTab === 'crop' && <CropPanel onApplyCrop={handleApplyCrop} onSetAspect={setAspect} isLoading={isLoading} isCropping={!!completedCrop?.width && completedCrop.width > 0} />}
            {activeTab === 'adjust' && <AdjustmentPanel onApplyAdjustment={handleApplyAdjustment} isLoading={isLoading} />}
            {activeTab === 'filters' && <FilterPanel onApplyFilter={handleApplyFilter} isLoading={isLoading} />}
          </div>

          <div className="flex flex-wrap items-center justify-center gap-3 mt-6">
            <button onClick={handleUndo} disabled={!canUndo} className="flex items-center justify-center text-center bg-white/10 border border-white/20 text-gray-200 font-semibold py-3 px-5 rounded-md transition-all duration-200 ease-in-out hover:bg-white/20 hover:border-white/30 active:scale-95 text-base disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-white/5"><UndoIcon className="w-5 h-5 mr-2" />Undo</button>
            <button onClick={handleRedo} disabled={!canRedo} className="flex items-center justify-center text-center bg-white/10 border border-white/20 text-gray-200 font-semibold py-3 px-5 rounded-md transition-all duration-200 ease-in-out hover:bg-white/20 hover:border-white/30 active:scale-95 text-base disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-white/5"><RedoIcon className="w-5 h-5 mr-2" />Redo</button>
            <div className="h-6 w-px bg-gray-600 mx-1 hidden sm:block" />
            {canUndo && <button onMouseDown={() => setIsComparing(true)} onMouseUp={() => setIsComparing(false)} onMouseLeave={() => setIsComparing(false)} onTouchStart={() => setIsComparing(true)} onTouchEnd={() => setIsComparing(false)} className="flex items-center justify-center text-center bg-white/10 border border-white/20 text-gray-200 font-semibold py-3 px-5 rounded-md transition-all duration-200 ease-in-out hover:bg-white/20 hover:border-white/30 active:scale-95 text-base"><EyeIcon className="w-5 h-5 mr-2" />Compare</button>}
            <button onClick={handleReset} disabled={!canUndo} className="text-center bg-transparent border border-white/20 text-gray-200 font-semibold py-3 px-5 rounded-md transition-all duration-200 ease-in-out hover:bg-white/10 hover:border-white/30 active:scale-95 text-base disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-transparent">Reset</button>
            <button onClick={handleUploadNew} className="text-center bg-white/10 border border-white/20 text-gray-200 font-semibold py-3 px-5 rounded-md transition-all duration-200 ease-in-out hover:bg-white/20 hover:border-white/30 active:scale-95 text-base">Upload New</button>
            <button onClick={handleDownload} className="flex-grow sm:flex-grow-0 ml-auto bg-gradient-to-br from-green-600 to-green-500 text-white font-bold py-3 px-5 rounded-md transition-all duration-300 ease-in-out shadow-lg shadow-green-500/20 hover:shadow-xl hover:shadow-green-500/40 hover:-translate-y-px active:scale-95 active:shadow-inner text-base">Download Image</button>
          </div>
        </div>
      </main>
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<React.StrictMode><App /></React.StrictMode>);

    </script>
  </body>
</html>